<!DOCTYPE html>
<html>
<head>
    <title>Mappa Colonnine - EcoCharge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
</head>
<body>

<nav style="padding: 10px; background: #2980b9; color: white;">
    <span style="font-weight: bold;">EcoCharge User</span>
    <a href="{{ url_for('logout') }}" style="color: white; float: right;">Logout</a>
</nav>

<h2 style="text-align: center; margin-top: 20px;">Mappa Colonnine</h2>

<div id="map" style="height: 600px; width: 90%; margin: 20px auto;"></div>

<script>
    const colonnine = {{ colonnine | tojson }};
    const map = L.map('map').setView([45.4642, 9.19], 13);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Map data Â© <a href="https://openstreetmap.org">OpenStreetMap</a>'
    }).addTo(map);

    colonnine.forEach(c => {
        const icon = L.icon({
            iconUrl: c.occupata ? 
                'https://maps.google.com/mapfiles/ms/icons/red-dot.png' :
                'https://maps.google.com/mapfiles/ms/icons/green-dot.png',
            iconSize: [32, 32]
        });

        const buttonHtml = c.occupata
            ? `<button onclick="liberaColonnina(${c.id_colonnina})">Libera</button>`
            : `<button onclick="prenotaColonnina(${c.id_colonnina})">Prenota</button>`;

        L.marker([c.latitudine, c.longitudine], {icon: icon})
         .addTo(map)
         .bindPopup(`<b>${c.indirizzo}</b><br>Potenza: ${c.potenza_kw} kW<br>${buttonHtml}`);
    });

    function prenotaColonnina(id) {
        fetch(`/prenota/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                if(data.success) location.reload();
            })
            .catch(err => alert('Errore di rete: ' + err));
    }

    function liberaColonnina(id) {
        fetch(`/libera/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(data => {
                alert(data.message);
                if(data.success) location.reload();
            })
            .catch(err => alert('Errore di rete: ' + err));
    }
</script>

</body>
</html>
